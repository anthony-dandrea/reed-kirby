$(function() {
  // Render custom cart
  var myTemplate = $('#cart-template').text();
  paypal.minicart.render({
    template: myTemplate
  });
  // Check for reset param
  if (window.location.search.indexOf('success') > -1) {
    paypal.minicart.reset();
    localStorage.coupon = 0;
  }
  // Cart click
  $('[data-cart]').on('click', function(e) {
    e.stopPropagation();
    paypal.minicart.view.toggle();
  });
  // Check cart for changes
  function cartIconUpdate() {
    setTimeout(function() {
      // discount is global var for coupon
      var cart = paypal.minicart.cart.subtotal() - localStorage.coupon;
      if (cart<0) {
        cart = 0;
      }
      $('[data-cart-count]').text(cart);
    }, 100);
  }
  $(document).click(cartIconUpdate);
  cartIconUpdate();
});

// Set coupon if not set
if (!localStorage.coupon) {
  localStorage.coupon = 0;
}
$(function() {
  $(document).on('click', '[data-coupon-submit]', function(e) {
    e.preventDefault();
    // Check coupon isn't already used
    if (localStorage.coupon != 0) {
      alert('Only one coupon per order.')
      return;
    }
    var couponCode = $('[data-coupon]').val();
    $.post('assets/coupons.php', {'coupon': couponCode}, function(data) {
      data = JSON.parse(data);
      console.log('coupon',data);
      if (data.success) {
        $('[name="discount_amount_cart"]').val(data.value);
        localStorage.coupon = data.value;
        var newTotal = parseFloat($('#cart-total').text()) - data.value;
        $('#cart-total').text(newTotal);
        $(document).trigger('click');
      } else {
        alert(data.message);
      }
    }).fail(function() {
        alert('Server error, failed to check coupon.');
    });
  });
});

// Make sure enter not pressed while focused on coupon input
$(window).keydown(function(e){
   if(e.keyCode == 13 && $('[data-coupon]').is(':focus')) {
     e.preventDefault();
     return false;
   }
 });

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-35559033-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

$(function() {
  $('[data-menu-btn]').on('click', function(e) {
    e.preventDefault();
    $('[data-menu]').slideToggle();
  })
});
